---
title: "Income Census Dataset"
author: "Lidia Montero"
date: \today
output:
  html_document:
    toc: no
    toc_depth: '4'
  pdf_document:
    latex_engine: pdflatex
    number_sections: yes
    toc_depth: 4
    toc: yes
  word_document:
    toc: yes
    toc_depth: '4'
geometry: left=1.9cm,right=1.9cm,top=1.25cm,bottom=1.52cm
fontsize: 12pt
subtitle: 'Loading data and Sample selection'
editor_options: 
  chunk_output_type: console
---

This is an R Markdown document. 
We are showing some examples of EDA. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>. Use * to provide emphasis such as *italics* and **bold**.

Create lists: Unordered * and +     or   ordered   1. 2.  

  *klll

  1. Item 1
  2. Item 2
    + Item 2a
    + Item 2b

# Income Census Dataset

## Description 

*Input variables:* 

  1.  age: continuous.
  2.  workclass: Private, Self-emp-not-inc, Self-emp-inc, Federal-gov, Local-gov, State-gov, Without-pay, Never-worked.
  3.  fnlwgt: continuous.
  4.  education: Bachelors, Some-college, 11th, HS-grad, Prof-school, Assoc-acdm, Assoc-voc, 9th, 7th-8th, 12th, Masters, 1st-4th, 10th, Doctorate, 5th-6th, Preschool.
  5.  education-num: continuous.
  6.  marital.status: Married-civ-spouse, Divorced, Never-married, Separated, Widowed, Married-spouse-absent, Married-AF-spouse.
  7.  occupation: Tech-support, Craft-repair, Other-service, Sales, Exec-managerial, Prof-specialty, Handlers-cleaners, Machine-op-inspct, Adm-clerical, Farming-fishing, Transport-moving, Priv-house-serv, Protective-serv, Armed-Forces.
  7.  relationship: Wife, Own-child, Husband, Not-in-family, Other-relative, Unmarried.
  8.  race: White, Asian-Pac-Islander, Amer-Indian-Eskimo, Other, Black.
  9.  sex: Female, Male.
  10.  capital.gain: continuous.
  11.  capital.loss: continuous.
  12.  hours.per.week: continuous. Numeric target.
  13.  native.country: United-States, Cambodia, England, Puerto-Rico, Canada, Germany, Outlying-US(Guam-USVI-etc), India, Japan, Greece, South, China, Cuba, Iran, Honduras, Philippines, Italy, Poland, Jamaica, Vietnam, Mexico, Portugal, Ireland, France, Dominican-Republic, Laos, Ecuador, Taiwan, Haiti, Columbia, Hungary, Guatemala, Nicaragua, Scotland, Thailand, Yugoslavia, El-Salvador, Trinadad&Tobago, Peru, Hong, Holand-Netherlands.
  15.  y.bin: Making more than $50K per year. Binary target.


## Load Packages

```{r}
# Load Required Packages: to be increased over the course

options(contrasts=c("contr.treatment","contr.treatment"))

requiredPackages <- c("effects","FactoMineR","car", "chemometrics","missMDA", "factoextra","ggplot2","dplyr","ggmap","ggthemes","knitr")
missingPackages <- requiredPackages[!(requiredPackages %in% installed.packages()[,"Package"])]

if(length(missingPackages)) install.packages(missingPackages)

lapply(requiredPackages, require, character.only = TRUE)

# Manual installation and loading of package
install.packages("mlogit")
library(mlogit)

```

## Load Sample

```{r}
# Clear objects
rm(list=ls())
# Clear plots
if(!is.null(dev.list())) dev.off()

# Command or Windows-like method
# Muestra acabada lab2 with missings
load("sample.RData")
summary(df)
```

# Data Preparation

```{r}
names(df)

#lista de variables continuas y variables discretas
vars_con<-names(df)[c(1,3,5,11:13)];vars_con
vars_dis<-names(df)[c(2,4,6:10,14:18)];vars_dis
vars_res<-names(df)[c(13,15)];vars_res

# summary de ciertas columnas [,]si se deja en blanco -> toda la dimenasión
summary(df[,vars_con])
summary(df[,vars_dis])


```





# Guardar los datos
```{r}
# Contiene las nuevas variables pero no hemos hecho un tratamiento de la calidad
save("Adult5000WithMissings.RData")
```




# Lab3
```{r}
# lista vars_res con variables target -> hour.per.week, y.bin, factor.hour.per.week
#iqr -> distancia intercuantil

# en la variable target (hours per week y bin) nada de imputación -> eliminar errores y outliers -> Special treatment
# convertir outliers/errors en misssing excepto en la variable target
```





# User-defined functions
```{r, echo=FALSE}

# Some useful functions
calcQ <- function(x) {
  s.x <- summary(x)
  iqr<-s.x[5]-s.x[2]
  list(souti=s.x[2]-3*iqr, mouti=s.x[2]-1.5*iqr, min=s.x[1], q1=s.x[2], q2=s.x[3], 
       q3=s.x[5], max=s.x[6], mouts=s.x[5]+1.5*iqr, souts=s.x[5]+3*iqr ) }

countNA <- function(x) {
  mis_x <- NULL
  for (j in 1:ncol(x)) {mis_x[j] <- sum(is.na(x[,j])) }
  mis_x <- as.data.frame(mis_x)
  rownames(mis_x) <- names(x)
  mis_i <- rep(0,nrow(x))
  for (j in 1:ncol(x)) {mis_i <- mis_i + as.numeric(is.na(x[,j])) }
  list(mis_col=mis_x,mis_ind=mis_i) }

```


# Missing data: initial situation

```{r}
miss<-countNA(df)
attributes(miss)
miss$mis_col  # Number of missing values for each variable
summary(df)
miss$mis_ind # Number of missing values in variables for each observation
summary(miss$mis_ind)
quantile(miss$mis_ind,seq(0,1,0.1))
```

# Outliers and Errors: initial situation

```{r}


iout<-rep(0,nrow(df))
jout<-rep(0,length(vars_con))

ierr<-rep(0,nrow(df))
jerr<-rep(0,ncol(df))
```

## hr.per.week (numeric target)

```{r}
summ<-summary(df$`hours-per-week`)
boxplot(df$`hours-per-week`,main="Boxplot hours-per-week",col="orange")
barplot(table(df$`hours-per-week`))

iqr<-summ[5]-summ[2];iqr
souts<-summ[5]+3*iqr  # upper threshold
souti<-summ[2]-3*iqr# lower threshold
souti;souts

ll<-which((df$`hours-per-week`<souti)|(df$`hours-per-week`>souts));length(ll)

ll<-which((df$`hours-per-week`<5)|(df$`hours-per-week`>80));length(ll)

### Special treatment: target - Errors or Severe outliers - Remove

dff<-df[-ll,]

### End Special treatment: target - Errors or Severe outliers - Remove

# Update iout,jout,ierr,jerr
jerr[13]<-jerr[13]+length(ll)
ierr[ll]<-ierr[ll]+1; ierr

calcQ(df$`hours-per-week`)

boxplot(dff$`hours-per-week`,main="Boxplot hr.per.week",col="orange")
abline(h=calcQ(dff$`hours-per-week`)$souti,lwd=2,col="red",lty=2)
abline(h=calcQ(dff$`hours-per-week`)$souts,lwd=2,col="red",lty=2)

```

Fer per totes les variables numèriques (outliers i errors) i factors (errors, si cal identifiqueu les categories missing).


## y.bin (target)

```{r}

summ<-summary(df$Y.bin); summ
barplot(table(df$Y.bin))

```



## Age

```{r}
summ<-summary(df$age);summ
boxplot(df$age,main="Boxplot age",col="orange")
barplot(table(df$age))

iqr<-summ[5]-summ[2];iqr
souts<-summ[5]+3*iqr  # upper threshold
souti<-summ[2]-3*iqr# lower threshold
souti;souts

ll<-which((df$age<souti)|(df$age>souts));length(ll)


# Update iout,jout,ierr,jerr

calcQ(df$age)

boxplot(dff$age,main="Boxplot age",col="orange")
abline(h=calcQ(dff$age)$souti,lwd=2,col="red",lty=2)
abline(h=calcQ(dff$age)$souts,lwd=2,col="red",lty=2)
```

## Capital-gain
```{r}
summ<-summary(df$`capital-gain`);summ
boxplot(df$`capital-gain`,main="Boxplot capital gain",col="orange")
barplot(table(df$`capital-gain`))

iqr<-summ[5]-summ[2];iqr
souts<-summ[5]+3*iqr  # upper threshold
souti<-summ[2]-3*iqr# lower threshold
souti;souts

ll<-which((df$`capital-gain`<souti)|(df$`capital-gain`>souts));length(ll)

ll<-which(df$`capital-gain`==99999); length(ll)

# Update iout,jout,ierr,jerr
# CAMBIAR 13 POR EL CORRECTO
jerr
jerr[13]<-jerr[13]+length(ll)
ierr[ll]<-ierr[ll]+1

```


## Capital-loss
```{r}
summ<-summary(df$`capital-loss`);summ
boxplot(df$`capital-loss`,main="Boxplot Capital-loss",col="orange")
barplot(table(df$`capital-loss`))

iqr<-summ[5]-summ[2];iqr
souts<-summ[5]+3*iqr  # upper threshold
souti<-summ[2]-3*iqr# lower threshold
souti;souts

ll<-which((df$`capital-loss`<souti)|(df$`capital-loss`>souts));length(ll)

ll<-which(df$`capital-loss`==99999); length(ll)

# Update iout,jout,ierr,jerr
# CAMBIAR 13 POR EL CORRECTO
jerr
jerr[13]<-jerr[13]+length(ll)
ierr[ll]<-ierr[ll]+1
```



## Workclass
```{r}
summ<-summary(df$workclass);summ
barplot(table(df$workclass))

ll<-which(is.na(df$workclass)); length(ll)

# missings, no hay errores

```







# Imputation

Set some reasonable value to missing data. Missing can be an original missing or an error/outlier set to missing

## Imputation of numeric variables

```{r}
dff<-df
#library(missMDA)
summary(dff[,vars_con])  # Problem with capital_gain
ll<-which(dff$`capital-gain`==99999); length(ll)
dff$`capital-gain`[ll]<-NA
res_num<-imputePCA(dff[,vars_con],ncp = 5)
summary(res_num$completeObs)



par(mfrow=c(1,2))
boxplot(dff$capital.gain)
boxplot(res_num$completeObs[,"capital.gain"])
par(mfrow=c(1,1))

dff$`capital-gain`<-res_num[,"capital-gain"]

```



## Imputation of factors

En las transparencias Data Filtering and Validation

```{r}

#library(missMDA)
# Categorical imputation
summary(dff[,vars_dis])  # Problem with NA's
nb <- estim_ncpMCA(dff[, vars_dis],ncp.max=25)
res_dis<-imputeMCA(dff[,vars_dis],ncp=25)
summary(res_dis$completeObs)


# pasar los datos obtenidos al data frame
#dff<-


```





# Guardar los datos
```{r}
# Contiene las nuevas variables pero no hemos hecho un tratamiento de la calidad
save("Adult5000WithoutMissings.RData")
```










